<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mock API Manager</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="container">
    <aside class="left-panel">
      <h1 class="left-title">Mock API Manager</h1>
      <div class="tabs">
        <button class="tab-btn active" data-tab="create">Create Mock</button>
        <button class="tab-btn" data-tab="manage">Manage Mocks</button>
        <button class="tab-btn" data-tab="import">Import</button>
      </div>
    </aside>
    
    <section class="right-panel">
      <!-- CREATE/EDIT MOCK TAB -->
      <div id="createTab" class="tab-content active">
        <h2 id="formTitle">Create New Mock</h2>
        
        <!-- JSON IMPORT SECTION -->
        <div class="json-import-section" style="background: linear-gradient(135deg, #f6f0e2 0%, #fff9ed 100%); padding: 1.25rem; border-radius: 14px; margin-bottom: 1.5rem; border: 2px dashed #bb8b44; box-shadow: 4px 4px 12px rgba(187, 139, 68, 0.15);">
          <h3 style="margin: 0 0 0.75rem 0; font-size: 1.1rem; color: #854505; font-weight: 700;">
            Quick Test: Import JSON Mock
          </h3>
          <p style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #6d4c41; line-height: 1.5;">
            Upload one or more JSON files to create <strong style="color: #a65b1b;">temporary mocks</strong> for immediate testing (in-memory only).
            They will auto-vanish when you push the same mocks to GitHub. Supports AEM-captured mock format.
          </p>
          <div style="display: flex; gap: 0.75rem; align-items: center;">
            <input type="file" id="jsonFileInput" accept=".json,application/json" multiple style="display: none;" />
            <button type="button" id="importJsonBtn" class="btn-secondary" style="background: linear-gradient(90deg, #bc6c25, #a35203); color: #fff6e7; border: none; border-radius: 12px; padding: 10px 20px; font-weight: 700; cursor: pointer; box-shadow: 4px 4px 12px rgba(140, 90, 20, 0.4); transition: all 0.3s ease;">
              Import JSON File(s)
            </button>
            <span id="jsonFileName" style="font-size: 0.9rem; color: #6d4c41;"></span>
          </div>
          <div id="jsonImportMessage" class="message" style="margin-top: 0.75rem;"></div>
        </div>
        
        <div style="text-align: center; margin-bottom: 1.5rem; color: #a67c52; font-size: 0.9rem; font-weight: 600;">
          — OR Create Manually —
        </div>
        
        <form id="mockApiForm" novalidate>
          <input type="hidden" id="mockId" value="" />
          
          <label for="businessName">Business Name / Description (Optional)</label>
          <input type="text" id="businessName" placeholder="e.g., Admin User Login" />
          
          <label for="apiName">API Path <span class="required">*</span>
            <span style="color: #888; font-size: 13px; display: block;">
              <em>Plain path = exact match. Regex patterns supported (auto-detected). Examples: users/login (exact) or users/\d+/orders (regex)</em>
            </span>
          </label>
          <input type="text" id="apiName" required placeholder="users/login (exact) or users/\d+/orders (regex)" />

          <label for="method">HTTP Method</label>
          <select id="method">
            <option value="POST" selected>POST</option>
            <option value="GET">GET</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>

          <label for="predicateRequest">Request Body Matching Criteria (Optional)
            <span style="color: #888; font-size: 13px; display: block;">
              <em>Match requests with specific JSON body content. Leave empty to match any body.</em>
            </span>
          </label>
          <textarea id="predicateRequest" placeholder='e.g., { "userType": "admin" }'></textarea>

          <label for="predicateHeaders">Request Headers Matching Criteria (Optional)
            <span style="color: #888; font-size: 13px; display: block;">
              <em>Use "*" to match any value (dynamic tokens). Otherwise exact match.</em>
            </span>
          </label>
          <textarea id="predicateHeaders" placeholder='{ "authorization": "*" } or { "x-api-key": "exact-value" }'></textarea>

          <label for="predicateQuery">Query Parameters Matching Criteria (Optional)
            <span style="color: #888; font-size: 13px; display: block;">
              <em>Use "*" to match any value (pagination). Otherwise exact match.</em>
            </span>
          </label>
          <textarea id="predicateQuery" placeholder='{ "page": "*", "limit": "*" } or { "status": "active" }'></textarea>

          <label for="requestPayload">Request Payload (Optional)
            <span style="color: #888; font-size: 13px; display: block;">
              <em>Fallback body matching if Body Criteria is not provided.</em>
            </span>
          </label>
          <textarea id="requestPayload" placeholder='e.g., { "id": 123 }'></textarea>

          <label for="responseHeaders">Response Headers JSON (Optional)</label>
          <textarea id="responseHeaders" placeholder='e.g., { "x-powered-by": "nodejs" }'></textarea>

          <label for="latencyMs">Response Latency (milliseconds)
            <span style="color: #888; font-size: 13px; display: block;">
              <em>Simulates API delay. Default: 0ms (instant) | Fast: 50-100ms | Normal: 200-500ms | Slow: 1000-3000ms</em>
            </span>
          </label>
          <input type="number" id="latencyMs" name="latencyMs" placeholder="0" min="0" max="30000" value="0" />

          <label for="responseType">Response Type</label>
          <select id="responseType">
            <option value="static" selected>Static (JSON Response)</option>
            <option value="dynamic">Dynamic (JavaScript Function)</option>
          </select>

          <div id="staticResponseSection">
            <label for="responseBody">Response Body JSON
              <span style="color: #888; font-size: 13px; display: block;">
                <em>The JSON response to return. Can be empty {} for 204 No Content responses.</em>
              </span>
            </label>
            <textarea id="responseBody" placeholder='e.g., { "status": "success" } or just {}'></textarea>
          </div>

          <div id="dynamicResponseSection" style="display: none;">
            <label for="responseFunction">Response Function (JavaScript)
              <span style="color: #888; font-size: 13px; display: block;">
                <em>JavaScript function that returns a dynamic response. Has access to 'request' object.</em>
              </span>
            </label>
            <textarea id="responseFunction" rows="12" placeholder='(request) => {
  // Example: Time-based validation (within 2 minutes)
  const now = new Date();
  const requestTime = new Date(request.body.timestamp);
  const diffMinutes = (now - requestTime) / 60000;
  
  return {
    statusCode: diffMinutes <= 2 ? 200 : 400,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      valid: diffMinutes <= 2,
      message: diffMinutes <= 2 ? "Within time window" : "Request expired",
      currentTime: now.toISOString(),
      requestTime: requestTime.toISOString(),
      differenceMinutes: Math.round(diffMinutes * 100) / 100
    })
  };
}'></textarea>
          </div>

          <div class="button-group">
            <button type="submit" id="submitBtn">Save Mock</button>
            <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
          </div>
          <div id="message" class="message"></div>
        </form>
      </div>

      <!-- MANAGE MOCKS TAB -->
      <div id="manageTab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="margin: 0;">Manage Mocks</h2>
          <div style="display: flex; gap: 0.75rem;">
            <button type="button" id="exportMongoDBMocks" class="btn-primary">Export MongoDB Mocks (JSON)</button>
          </div>
        </div>
        <div id="mocksList">
          <p class="loading">Loading mocks...</p>
        </div>
      </div>

      <!-- IMPORT TAB -->
      <div id="importTab" class="tab-content">
        <h2>Import Mocks from Excel/CSV</h2>
        
        <div class="import-instructions">
          <p><strong>Supported formats:</strong> .xlsx, .csv</p>
          <p><strong>Required columns</strong> (flexible names accepted):</p>
          <ul>
            <li><strong>Business Name</strong> - Description or name of the API (optional)</li>
            <li><strong>Path/Endpoint</strong> - API path like /users/login</li>
            <li><strong>Request</strong> - Request body JSON (leave empty for any request)</li>
            <li><strong>Response</strong> - Response body JSON</li>
          </ul>
        </div>

        <div class="import-upload">
          <input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display:none;" />
          <div class="file-drop-zone" id="fileDropZone">
            <p>Drop file here or click to browse</p>
            <button type="button" class="btn-upload">Choose File</button>
          </div>
        </div>

        <div class="import-templates">
          <button type="button" class="btn-template" id="downloadCsvTemplate">Download CSV Template</button>
          <button type="button" class="btn-template" id="downloadXlsxTemplate">Download XLSX Template</button>
        </div>

        <div id="importPreview" class="import-preview" style="display:none;">
          <h3>Preview</h3>
          <div id="importPreviewContent"></div>
          <div class="import-actions">
            <button type="button" id="cancelImport" class="btn-secondary">Cancel</button>
            <button type="button" id="importSelected" class="btn-primary">Import Selected</button>
          </div>
        </div>

        <div id="importMessage" class="message"></div>
      </div>
    </section>

    <!-- Test Modal -->
    <div id="testModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h2>Test Mock Variant</h2>
        <div id="testMockInfo" class="test-info"></div>
        
        <label>Test Path <span style="color: #888; font-size: 13px;">(e.g., /users/123/profile - no /mock prefix)</span></label>
        <input type="text" id="testPath" placeholder="/users/123/profile" style="margin-bottom: 15px;" />
        
        <label>Request Headers (JSON)</label>
        <textarea id="testHeaders" placeholder='{"authorization": "Bearer token", "content-type": "application/json"}'></textarea>
        
        <label>Query Parameters (JSON)</label>
        <textarea id="testQuery" placeholder='{"page": "1", "limit": "10"}'></textarea>
        
        <label>Request Body (JSON)</label>
        <textarea id="testBody" placeholder='{"field": "value"}'></textarea>
        
        <div class="button-group">
          <button type="button" id="executeTest" class="btn-primary">Send Request</button>
          <button type="button" id="closeTest" class="btn-secondary">Close</button>
        </div>
        
        <div id="testResult" class="test-result" style="display:none;">
          <h3>Response</h3>
          <div id="testResultContent"></div>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="script.js"></script>
</body>
</html>
